{% extends "admin/base_site.html" %}
{% load static %}
{% load formatar_numero %}
{% load l10n %} {# <-- importante para usar unlocalize #}
{% block extrahead %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div id="app-data" data-harvest-id="{{ HARVEST_ID }}" data-farm-id="{{ FARM_ID }}"
        data-response-id="{{ RESPONSE_ID }}" data-charge-id="{{ CHARGE_ID }}" data-token="{{ YOUR_TOKEN }}">
    </div>
    <h2 class="mb-4">üì¶ Abrir Aplica√ß√£o no Farmbox - <strong>{{projeto_nome}}</strong></h2>

    <div class="mb-3">
        <label class="form-label"><strong>√Årea total selecionada:</strong></label>
        <strong>
            <input type="text" class="form-control" id="total-area-display"
                value="{{ total_area|formatar_numero_br }} H√°" readonly>
        </strong>
    </div>

    <div class="mb-4">
        <h5>Plantios Selecionados:</h5>
        {% for p in plantios %}
        <div class="plantio-wrapper mb-2" data-plantation-id="{{ p.id_farmbox }}">
            <div class="card p-3">
                <input type="hidden" name="plantation_id" value="{{ p.id_farmbox|stringformat:'d' }}">
                <div class="d-flex align-items-center flex-wrap gap-3 justify-content-between">
                    <div class="d-flex align-items-center flex-wrap gap-3">
                        <div>
                            {% with cultura=p.variedade.cultura.cultura %}
                            {% if cultura == "Soja" %}
                            <img src="{% static 'images/icons/soy.png' %}" alt="Soja"
                                style="width: 20px; height: 20px;" />
                            {% elif cultura == "Feij√£o" %}
                            <img src="{% static 'images/icons/beans2.png' %}" alt="Feij√£o"
                                style="width: 20px; height: 20px;" />
                            {% elif cultura == "Arroz" %}
                            <img src="{% static 'images/icons/rice.png' %}" alt="Arroz"
                                style="width: 20px; height: 20px;" />
                            {% else %}
                            <span>Sem √≠cone</span>
                            {% endif %}
                            {% endwith %}
                        </div>
                        <div><strong></strong> {{ p.talhao.id_talhao }}</div>
                        <div><strong></strong> {{ p.variedade }}</div>
                        <div><strong></strong> {{ p.safra }} - {{ p.ciclo }}</div>
                        <div class="d-flex align-items-center gap-2">
                            <label for="area-{{ forloop.counter }}" class="form-label me-1 mb-0">
                                <strong>√Årea (H√°):</strong>
                            </label>
                            <input type="number" step="any" class="form-control form-control-sm area-input"
                                name="sought_area"
                                value="{% with p.area_colheita|stringformat:'f' as area_float %}{{ area_float|slice:':-4' }}{% endwith %}"
                                data-plantation-id="{{ p.id_farmbox }}" style="max-width: 90px;">
                        </div>
                    </div>

                    <!-- Bot√£o remover -->
                    <button type="button" class="btn btn-sm btn-outline-danger remove-plantio-btn"
                        onclick="removerPlantio(this)">
                        Remover
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <hr />

    <h5>Adicionar Defensivos</h5>
    <div id="defensivos-container" class="mb-3">
        <div class="defensivo-group d-flex align-items-center gap-2 mb-2">
            <select name="input_id" class="form-select form-select-sm w-auto" style="min-width: 220px;" required>
                <option value="">-- Selecione um defensivo --</option>
                {% for d in defensivos %}
                <option value="{{ d.id_farmbox_str|stringformat:'d' }}" data-unidade="{{ d.unidade_medida }}">
                    {{ d.produto }}
                </option>
                {% endfor %}
            </select>

            <input type="number" step="0.01" name="dosage_value" class="form-control form-control-sm w-auto"
                placeholder="Dose (ex: 0.2)" style="width: 100px;" required>

            <button type="button" class="btn btn-outline-primary btn-sm" onclick="duplicarLinha(this)">+</button>
            <button type="button" class="btn btn-outline-danger btn-sm remove-defensivo-btn"
                onclick="removerLinha(this)">‚àí</button>

            <!-- Nova coluna para resultado -->
            <div class="dose-result" style="min-width: 80px; text-align: right; font-weight: 600;">
                0,00
            </div>
        </div>
    </div>

    <button type="button" class="btn btn-success" id="btn-submit" onclick="enviarAplicacao()">‚úÖ Confirmar
        Aplica√ß√£o</button>
</div>

{% endblock %}
{% block extra_js %}
<script src="{% static 'admin/js/abrir_aplicacao_farmbox.js' %}"></script>
<script>
    // Essa parte ainda precisa ficar inline por conter dados do Django
    function enviarAplicacao() {
        const btn = document.getElementById("btn-submit");
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML =
            `<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Enviando...`;

        const inputs = [];
        const defensivoGroups = document.querySelectorAll(".defensivo-group");
        const areaInputs = document.querySelectorAll("input[name='sought_area']");
        const plantations = [];

        areaInputs.forEach(input => {
            const plantation_id = parseInt(input.dataset.plantationId.replace(/\./g, ''), 10);
            const sought_area = parseFloat(input.value);
            if (!isNaN(sought_area)) {
                plantations.push({
                    plantation_id: plantation_id,
                    sought_area: sought_area
                });
            }
        });

        defensivoGroups.forEach(group => {
            const defensivoId = group.querySelector("select[name='input_id']").value;
            const dose = group.querySelector("input[name='dosage_value']").value;
            if (defensivoId && dose) {
                const selectedOption = group.querySelector("select[name='input_id']").selectedOptions[0];
                const unidade = selectedOption.dataset.unidade;
                inputs.push({
                    input_id: parseInt(defensivoId.replace(/\./g, ''), 10),
                    dosage_value: parseFloat(dose),
                    dosage_unity: unidade || null,
                });
            }
        });

        const payload = {
            date: new Date().toISOString().slice(0, 10),
            end_date: new Date(Date.now() + 6 * 86400000).toISOString().slice(0, 10),
            harvest_id: parseInt("{{ HARVEST_ID|default:'0' }}".replace(/\./g, '')),
            farm_id: parseInt("{{ FARM_ID|default:'0' }}".replace(/\./g, '')),
            responsible_id: parseInt("{{ RESPONSE_ID|default:'0' }}".replace(/\./g, '')),
            charge_id: parseInt("{{ CHARGE_ID|default:'0' }}".replace(/\./g, '')),
            plantations: plantations,
            inputs: inputs,
            observations: "Aplica√ß√£o Aberta via Admin"
        };

        fetch("/diamante/plantio/open_app_farmbox/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Token {{ YOUR_TOKEN }}"
                },
                body: JSON.stringify({
                    data: payload
                })
            })
            .then(async response => {
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data ? .msg || "Erro desconhecido ao enviar aplica√ß√£o.");
                }

                Swal.fire({
                    icon: "success",
                    title: "Aplica√ß√£o criada!",
                    text: data.msg || "Aplica√ß√£o aberta com sucesso.",
                    confirmButtonText: "OK"
                }).then(() => {
                    window.location.href = document.referrer;
                });
            })
            .catch(err => {
                Swal.fire({
                    icon: "error",
                    title: "Erro!",
                    text: err.message || "Erro ao enviar aplica√ß√£o."
                });
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
    }
</script>
{% endblock %}